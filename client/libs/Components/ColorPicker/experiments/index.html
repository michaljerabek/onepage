<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>

        * {
            box-sizing: border-box;
        }

        .ColorPicker {
            width: 100%;

            display: flex;
            flex-wrap: wrap;
        }

        .ColorPicker *:not(input) {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -o-user-select: none;
            user-select: none;
            cursor: default;
        }

        .ColorPicker--widget-wrapper {
            margin-bottom: 24px;
            margin-right: 24px;

            flex-basis: 222px;
            flex-shrink: 0;

            display: flex;
            flex-wrap: wrap;
        }

        .ColorPicker--HSV-wrapper {
            display: flex;
        }

        .ColorPicker--SV-box {
            position: relative;
            margin-bottom: 10px;

            width: 200px;
            height: 200px;

            background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), #000), linear-gradient(to right, #fff, rgb(255, 0, 0));
            outline: 1px solid black;

            flex-shrink: 0;

            will-change: background-image;
        }

        .ColorPicker--H-box {
            position: relative;
            margin-left: 10px;

            height: 200px;
            width: 14px;

            background-image: linear-gradient(to top, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
            border: 1px solid black;

            flex-shrink: 0;
        }

        .ColorPicker--SV-selector {
            position:absolute;
            top: -6px;
            left: -6px;
            transform: translate(0px, 0px);

            width: 12px;
            height: 12px;

            border-radius: 50%;
            border: 1px solid red;

            will-change: transform;
            transition: transform 0.25s cubic-bezier(.1, 1, .6, 1) 0s;
        }

        .ColorPicker--H-selector {
            position:absolute;
            top: -5px;
            left: -2px;
            transform: translateY(0px);

            width: 16px;
            height: 8px;

            border: 1px solid red;

            will-change: transform;
            transition: transform 0.25s cubic-bezier(.1, 1, .6, 1) 0s;
        }

        .ColorPicker--input {
            width: 100%;

            display: flex;
        }

        .ColorPicker--type-selector {
            line-height: 32px;

            margin-right: 8px;

            width: 64px;
            height: 32px;
            padding: 0 4px;
            flex-shrink: 0;
        }

        .ColorPicker--input-text {
            line-height: 32px;

            padding: 0 8px;
            width: 100%;
            height: 32px;
        }

        .ColorPicker--palettes {
            margin-bottom: auto;

            min-width: 204px;
            flex-basis: 50%;

            display: flex;
            flex-wrap: wrap;
        }

        .ColorPickerPalette {
            margin-right: 48px;
            margin-bottom: 24px;

            display: flex;
            flex-direction: column;
        }

        .ColorPickerPalette--title {
            font-size: 14px;
            white-space: nowrap;

            margin: 0;
            margin-bottom: 8px;
        }

        .ColorPickerPalette--colors {
            display: flex;
        }

        .ColorPickerPalette--color {
            margin-right: 4px;

            width: 32px;
            height: 32px;

            border: 1px solid black;
            transition: background-color 0.25s cubic-bezier(.1, 1, .6, 1) 0s;
        }

    </style>

</head>
<body>

    <div id="app"></div>

    <script id="App" type="text/html">

        <ColorPicker output="{{.bg}}">
            <ColorPickerPalette title="Barvy" colors="['rgb(255, 0, 0)', 'rgb(0, 255, 0)', 'rgb(0, 0, 255)']" />
            <ColorPickerPalette title="Obrázek" image="img2.jpg" />
        </ColorPicker>

        <ColorPicker output="{{.color}}" input="{{#if .color}}[[.color]]{{else}}rgb(12, 35, 90){{/if}}">
            <ColorPickerPalette title="Barvy" colors="['rgb(255, 0, 0)', 'rgb(0, 255, 0)', 'rgb(0, 0, 255)']" />
            <ColorPickerPalette title="Obrázek" image="img2.jpg" />
        </ColorPicker>

        <div class="selected" style="display: inline-block; margin-top: 24px; height: 50px; background: {{.bg}}; border: 1px solid {{.border}};">
            <h1 style="margin: 0; line-height: 50px; color: {{.color}}">Text Text Text</h1>
            <img style="width: 100%; float: left" src="img2.jpg" alt="">
        </div>

    </script>

    <script id="ColorPicker" type="text/html">

        <div class="ColorPicker">

            <div class="ColorPicker--widget-wrapper">

                <div class="ColorPicker--HSV-wrapper">

                    <div on-mousedown-touchstart="activateSelector(event, 'SV')" class="ColorPicker--SV-box" style="background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), #000), linear-gradient(to right, #fff, {{.SVBoxHue}});">
                        <div on-mousedown-touchstart="activateSelector(event, 'SV')" style="transform: translate({{SVSelector.x}}px, {{SVSelector.y}}px); transition: {{.animate ? '' : 'none'}}" class="ColorPicker--SV-selector"></div>
                    </div>

                    <div on-mousedown-touchstart="activateSelector(event, 'H')" class="ColorPicker--H-box">
                        <div on-mousedown-touchstart="activateSelector(event, 'H')" style="transform: translateY({{HSelector.y}}px); transition: {{.animate ? '' : 'none'}}" class="ColorPicker--H-selector"></div>
                    </div>

                </div>

                <div class="ColorPicker--input">

                    <select class="ColorPicker--type-selector" value="{{.inputType}}">
                        <option value="RGB">RGB</option>
                        <option value="HEX">HEX</option>
                    </select>

                    {{#if .inputType === "HEX"}}

                        <input placeholder="RRGGBB" class="ColorPicker--input-text ColorPicker--input-text__hex" type="text" on-keyup="inputTextHEXChanged(event)" value="{{.inputTextHEX}}">

                    {{else}}

                        <input placeholder="R" title="Červená [0–255]" class="ColorPicker--input-text ColorPicker--input-text-rgb" type="text" on-keyup="inputTextRGBChanged(event)" value="{{.inputTextR}}">
                        <input placeholder="G" title="Zelená [0–255]" class="ColorPicker--input-text ColorPicker--input-text-rgb" type="text" on-keyup="inputTextRGBChanged(event)" value="{{.inputTextG}}">
                        <input placeholder="B" title="Modrá [0–255]" class="ColorPicker--input-text ColorPicker--input-text-rgb" type="text" on-keyup="inputTextRGBChanged(event)" value="{{.inputTextB}}">

                    {{/if}}

                </div>
            </div>

            <div class="ColorPicker--palettes">

                <ColorPickerPalette title="Vybraná / Původní" colors="[{{current}}, {{initial}}]" />

                {{> content}}

            </div>

        </div>

    </script>

    <script id="ColorPickerPalette" type="text/html">

        <div class="ColorPickerPalette ColorPickerPalette">

            <h6 class="ColorPickerPalette--title">{{.title}}</h6>

            <div class="ColorPickerPalette--colors">
            {{#each .colors}}
                <div style="background-color: {{this}}; transition: {{animate ? '' : 'none'}}" on-click-touchend="setColor:{{this}},{{true}}" class="ColorPickerPalette--color"></div>
            {{/each}}
            </div>
        </div>

    </script>

    <script src="../../../U.js"></script>
    <script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>
    <script src="hammer.min.js"></script>
    <script src="http://cdn.ractivejs.org/edge/ractive.min.js"></script>
    <script src="ractive-touch.js"></script>
    <script src="spectra.js"></script>
    <script src="Vibrant.js"></script>

    <script>/*jslint indent: 4, white: true, nomen: true, regexp: true, unparam: true, node: true, browser: true, devel: true, nomen: true, plusplus: true, regexp: true, sloppy: true, vars: true*/
    /*global Ractive, Spectra, $, U, Vibrant*/

        var ColorPickerPalette = Ractive.extend({
            template: "#ColorPickerPalette",

            onconfig: function () {

                if (this.get("image")) {

                    setTimeout(function() {

                        this.getPaletteFromImage();

                    }.bind(this), 0);
                }
            },

            getPaletteFromImage: function () {

                this.image = new Image();

                this.image.onload = function (e) {

                    var vibrant = new Vibrant(e.target, 48, 8),

                        palette = vibrant.swatches(),

                        rgbs = [];

                    $.each(palette, function (i, color) {

                        if (color) {

                            rgbs.push("rgb(" + color.getRgb().join(",") + ")");
                        }
                    }.bind(this));

                    this.set("colors", rgbs);

//                    var vibrant = new Vibrant(e.target, 48, 8, function (vibrant) {
//
//                        var palette = vibrant.swatches(),
//
//                            rgbs = [];
//
//                        $.each(palette, function (i, color) {
//
//                            if (color) {
//
//                                rgbs.push("rgb(" + color.rgb.join(",") + ")");
//                            }
//                        }.bind(this));
//
//                        this.set("colors", rgbs);
//                    }.bind(this));
//

                }.bind(this);

                this.image.src = this.get("image");
            }
        });

        var ColorPicker = Ractive.extend({

            template: "#ColorPicker",

            components: {
                ColorPickerPalette: ColorPickerPalette
            },

            computed: {
                SVBoxHue: function () {

                    return this.HBoxColor.hue(this.get("hue") || 0).rgbaString();
                },
                current: function () {

                    return this.currentColor.rgbaString();
                }
            },

            data: function () {

                return {
                    initial: "rgb(255, 255, 255)",

                    SVSelector: {
                        x: 0,
                        y: 0
                    },

                    HSelector: {
                        y: 0
                    },

                    animate: false,

                    inputType: "HEX",
                    inputTextHEX: "",
                    inputTextR: "",
                    inputTextG: "",
                    inputTextB: ""
                };
            },

            onconstruct: function () {

                this.$win = $(window);
            },

            initializeColors: function () {

                var input = this.get("input");

                input = input || this.get("output");

                if (input) {

                    this.set("initial", input);
                }

                var current = input || this.get("initial");

                this.currentColor = Spectra(current);
                //slouží pro získání barvy gradientu v SVBoxu
                this.HBoxColor = Spectra({ h: 0, s: 1, v: 1 });

                //počáteční hodnoty barvy
                this.set("hue", 360 - this.currentColor.hue() || 360);
                this.set("saturation", this.currentColor.saturationv());
                this.set("value", this.currentColor.value());

                this.set("output", this.getCurrentRGB());
            },

            onconfig: function () {

                this.observe("input", function () {

                    this.initializeColors();

                    this.moveSelectorsToCurrentColorPosition(true);

                }, {init: false});

                this.initializeColors();

                this.observe("hue", function (hue) {

                    if (this.skiptHueObserver) {

                        return;
                    }

                    this.currentColor.hue(hue);

                    this.update("current");

                }, {init: false});

                this.observe("saturation", function (saturation) {

                    this.currentColor.saturationv(saturation);

                    this.preserveHue = true;

                    this.update("current");

                    this.preserveHue = false;

                }, {init: false});

                this.observe("value", function (value) {

                    this.currentColor.value(value);

                    this.preserveHue = true;

                    this.update("current");

                    this.preserveHue = false;

                }, {init: false});

                this.observe("current", function (color) {

                    //pokud se saturace změní na 0, pak si barva nezachová odstín
                    if (!this.preserveHue) {

                        this.skiptHueObserver = this.skipUpdateColor;

                        this.set("hue", this.currentColor.hue() || 360);

                        this.skiptHueObserver = false;
                    }

                    //pokud si barva nezachovala odstín je potřeba ho vrátit, jakmile barva získá saturaci
                    if (this.currentColor.hue() !== this.get("hue") && this.currentColor.saturationv()) {

                        this.currentColor.hue(this.get("hue"));
                    }

                    this.set("output", this.getCurrentRGB());

                    this.set("inputTextHEX", this.currentColor.hex());
                    this.set("inputTextR",   this.currentColor.red());
                    this.set("inputTextG",   this.currentColor.green());
                    this.set("inputTextB",   this.currentColor.blue());

                }, {init: false});

                this.observe("HSelector.y", function () {

                    if (!this.skipUpdateColor) {

                        this.updateHue.apply(this, arguments);
                    }
                }, {init: false});

                this.observe("SVSelector.x", function () {

                    if (!this.skipUpdateColor) {

                        this.updateSaturation.apply(this, arguments);
                    }
                }, {init: false});

                this.observe("SVSelector.y", function () {

                    if (!this.skipUpdateColor) {

                        this.updateValue.apply(this, arguments);
                    }
                }, {init: false});

                this.on("ColorPickerPalette.setColor", function (event, color, animate) {

                    this.setColor(color, animate);

                    event.original.preventDefault();
                });

                this.set("inputTextHEX", this.currentColor.hex());
                this.set("inputTextR",   this.currentColor.red());
                this.set("inputTextG",   this.currentColor.green());
                this.set("inputTextB",   this.currentColor.blue());
            },

            onrender: function () {

                this.SVBox = this.find(".ColorPicker--SV-box");
                this.SVSelector = this.find(".ColorPicker--SV-selector");

                this.HBox = this.find(".ColorPicker--H-box");
                this.HSelector = this.find(".ColorPicker--H-selector");

                this.moveSelectorsToCurrentColorPosition();

                this.fire("output", this.getCurrentRGB());
            },

            getCurrentRGB: function () {

                return "rgb(" + this.currentColor.red() + ", " + this.currentColor.green() + ", " + this.currentColor.blue() + ")";
            },

            updateSaturation: function () {

                var width = this.SVBox.offsetWidth,

                    x = this.get("SVSelector.x"),

                    saturation = Math.min(1, Math.max(0, (x / width)));

                this.set("saturation", saturation);
            },

            updateValue: function () {

                var height = this.SVBox.offsetHeight,

                    y = this.get("SVSelector.y"),

                    value = 1 - Math.min(1, Math.max(0, (y / height)));

                this.set("value", value);
            },

            updateHue: function () {

                var height = this.HBox.offsetHeight,

                    y = this.get("HSelector.y"),

                    hue = 360 - Math.min(360, Math.max(0, (y / height) * 360));

                this.preserveHue = true;

                this.set("hue", hue || 360);

                this.preserveHue = false;
            },

            moveSelectorsToCurrentColorPosition: function (animate) {

                this.moveHSelector(this.getHSelectorPosition(), animate);
                this.moveSVSelector(this.getSSelectorPosition(), this.getVSelectorPosition(), animate);
            },

            moveSVSelector: function (x, y, animate) {

                if (this.SVSelector) {

                    var width = this.SVBox.offsetWidth,
                        height = this.SVBox.offsetHeight;

                    x = Math.min(width, Math.max(0, x));
                    y = Math.min(height, Math.max(0, y));

                    this.set("animate", !!animate);

                    this.set("SVSelector.x", x);
                    this.set("SVSelector.y", y);
                }
            },

            moveHSelector: function (y, animate) {

                if (this.HSelector) {

                    var height = this.HBox.offsetHeight;

                    y = Math.min(height, Math.max(0, y));

                    this.set("animate", !!animate);

                    this.set("HSelector.y", y);
                }
            },

            setColor: function (color, animate) {

                this.currentColor = Spectra(color);

                //při zadávání barvy klávesnicí může dojít k malé změně barvy,
                //proto je potřeba zabránit její změně
                this.skipUpdateColor = true;

                this.update("current");

                this.moveHSelector(this.getHSelectorPosition(), animate);
                this.moveSVSelector(this.getSSelectorPosition(), this.getVSelectorPosition(), animate);

                this.skipUpdateColor = false;
            },

            getHSelectorPosition: function () {

                return this.HBox.offsetHeight - ((this.HBox.offsetHeight * (this.currentColor.hue() / 360) || this.HBox.offsetHeight));
            },

            getSSelectorPosition: function () {

                return this.SVBox.offsetWidth * this.currentColor.saturationv();
            },

            getVSelectorPosition: function () {

                return this.SVBox.offsetHeight * (1 - this.currentColor.value());
            },

            activateSelector: function(e, type) {

                var eventData = U.eventData(e);

                if (eventData.pointers > 1) {

                    return;
                }

                var movedToPosition = false,

                    selector              = type === "SV" ? ".ColorPicker--SV-selector" : ".ColorPicker--H-selector",
                    box                   = type === "SV" ? ".ColorPicker--SV-box"      : ".ColorPicker--H-box",
                    moveToPositionTimeout = type === "SV" ? "moveSVToPositionTimeout"   : "moveHToPositionTimeout",
                    moveSelectorFn        = type === "SV" ? "moveSVSelector"            : "moveHSelector",
                    dataSelector          = type === "SV" ? "SVSelector"                : "HSelector",

                    $selector = $(eventData.target).closest(selector),

                    selectorPosition = $selector.position(),
                    selectorHeight = $selector.height(),
                    selectorWidth = $selector.width(),

                    initPositions = {};

                initPositions.pointerY = eventData.clientY;
                initPositions.pointerX = eventData.clientX;

                initPositions.handleY = this.get(dataSelector + ".y");

                if (type === "SV") {

                    initPositions.handleX = this.get(dataSelector + ".x");
                }

                initPositions.startOffsetX = eventData.offsetX;
                initPositions.startOffsetY = eventData.offsetY;

                //událost vznikla na selektoru - je potřeba upravit pozici
                if ($selector.length) {

                    initPositions.startOffsetX += selectorPosition.left;
                    initPositions.startOffsetY += selectorPosition.top;
                }

                var moveToStartEventPosition = function (animate, byEndEvent) {

                        var args = [initPositions.startOffsetY, animate];

                        if (type === "SV") {

                            args.unshift(initPositions.startOffsetX);
                        }

                        this[moveSelectorFn].apply(this, args);

                        if (!byEndEvent) {

                            if (type === "SV") {

                                initPositions.handleY = this.getVSelectorPosition();
                                initPositions.handleX = this.getSSelectorPosition();

                            } else {

                                initPositions.handleY = this.getHSelectorPosition();
                            }
                        }

                        movedToPosition = true;

                    }.bind(this);

                clearTimeout(this[moveToPositionTimeout]);

                //pokud uživatel nepohne myší/prstem => přesunout na místo
                this[moveToPositionTimeout] = setTimeout(moveToStartEventPosition.bind(this, true), eventData.isTouchEvent ? 200 : 100);

                this.$win
                    .off(".ColorPicker")
                    .on("mousemove.ColorPicker touchmove.ColorPicker", function (e) {

                        var eventData = U.eventData(e);

                        if (!movedToPosition) {

                            clearTimeout(this[moveToPositionTimeout]);

                            //nejdříve je potřeba přesunout selektor na pozici myši/prstu
                            moveToStartEventPosition();
                        }

                        var args = [
                            initPositions.handleY + eventData.clientY - initPositions.pointerY
                        ];

                        if (type === "SV") {

                            args.unshift(initPositions.handleX + eventData.clientX - initPositions.pointerX);
                        }

                        this[moveSelectorFn].apply(this, args);

                        e.preventDefault();
                        return false;

                    }.bind(this))
                    .one("mouseup.ColorPicker touchend.ColorPicker", function (e) {

                        if (!movedToPosition) {

                            clearTimeout(this[moveToPositionTimeout]);

                            moveToStartEventPosition(true, true);
                        }

                        this.$win.off(".ColorPicker");

                        e.preventDefault();
                        return false;

                    }.bind(this));

                eventData.preventDefault();
                return false;
            },

            validateRGB: function (color) {

                return /rgb\(\s*(?:\d{1,3})\s*,\s*(?:\d{1,3})\s*,\s*(?:\d{1,3})\s*\)/.test(color);
            },

            validateHEX: function (color) {

                return /#?(?:[0-9a-f]{6})/i.test(color);
            },

            inputTextHEXChanged: function (event) {

                var currentHEX = this.get("inputTextHEX");

                if (this.validateHEX(currentHEX)) {

                    this.setColor(~currentHEX.indexOf("#") ? currentHEX : "#" + currentHEX, true);
                }
            },

            inputTextRGBChanged: function (event) {

                var currentRGB = "rgb(" + this.get("inputTextR") + ", " + this.get("inputTextG") + ", " + this.get("inputTextB") + ")";

                if (this.validateRGB(currentRGB)) {

                    this.setColor(currentRGB, true);
                }
            }

        });

        var app = new Ractive({
            el: "#app",
            template: "#App",

            components: {
                ColorPicker: ColorPicker
            },

            partials: {

            },
            data: {
//                color: "rgb(255, 255, 0)"
            },

            onconfig: function () {

                this.on("changeColor", this.changeColor);

            },

            changeColor: function (type, color) {
                console.log(arguments);
                this.set(type, color);
            }
        });

        var picker = app.findComponent("ColorPicker")
    </script>



</body>
</html>
