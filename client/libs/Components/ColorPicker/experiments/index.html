<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Document</title>

    <style>

        * {
            box-sizing: border-box;
        }

        .wrapper {
            width: 240px;
        }

    </style>

    <link rel="stylesheet" href="styles.css">

</head>
<body>

    <div id="app"></div>

    <script id="App" type="text/html">

        <ColorPicker output="{{.bg}}" noColor="true">
            <ColorPickerPalette title="RGB" colors="['red', '#0f0', 'blue']" />
            <ColorPickerPalette title="CMYK" colors="['rgb(0, 255, 255)', 'rgb(255, 0, 255)', 'rgb(255, 255, 0)', 'rgb(0, 0, 0)']" />
            <ColorPickerPalette title="Obrázek" image="img18.jpg" />
        </ColorPicker>

        <div class="wrapper">
<!--            <ColorPicker defer="true" on-output="changeColor:{{.switchToBorder ? 'border' : 'color'}}" input="{{#if .switchToBorder}}{{#if .border !== undefined}}[[.border]]{{else}}rgb(250, 35, 0){{/if}}{{else}}{{#if .color !== undefined}}[[.color]]{{else}}rgb(12, 35, 90){{/if}}{{/if}}">-->
            <ColorPicker output="{{.color}}" input="[[#if .color]][[.color]][[else]]rgb(12, 35, 90)[[/if]]">
                <ColorPickerPalette title="Barvy" colors="['rgb(255, 0, 0)', 'rgb(0, 255, 0)', 'rgb(0, 0, 255)']" />
                <ColorPickerPalette title="Obrázek" image="img18.jpg" />
            </ColorPicker>
        </div>

        <div class="selected" style="display: inline-block; margin-top: 24px; height: 50px; background: {{.bg}}; border: 1px solid {{.border}};">
            <h1 style="margin: 0; line-height: 50px; color: {{.color}}">Text Text Text</h1>
            <img style="width: 100%; float: left" src="img18.jpg" alt="">
        </div>

    </script>

    <script id="ColorPicker" type="text/html">

        <div class="ColorPicker">

            <div class="ColorPicker--wrapper-1">
                <div class="ColorPicker--wrapper-2">

                    <div class="ColorPicker--widget-wrapper">

                        <div class="ColorPicker--HSV-wrapper">

                            <div class="ColorPicker--SV-box"
                                on-mousedown-touchstart="activateSelector(event, 'SV')"
                                style="
                                    background-image:
                                        linear-gradient(to bottom, rgba(0, 0, 0, 0), #000),
                                        linear-gradient(to right, #fff, {{.SVBoxHue}});
                                "
                            >
                                <div class="ColorPicker--SV-selector"
                                    on-mousedown-touchstart="activateSelector(event, 'SV')"
                                    style="
                                        transform: translate({{SVSelector.x}}px, {{SVSelector.y}}px);
                                        transition: {{.animate ? '' : 'none'}};
                                    "
                                ></div>
                            </div><!--/ColorPicker--SV-box-->

                            <div class="ColorPicker--H-box"
                                on-mousedown-touchstart="activateSelector(event, 'H')"
                            >
                                <div class="ColorPicker--H-selector"
                                    on-mousedown-touchstart="activateSelector(event, 'H')"
                                    style="
                                        transform: translateY({{HSelector.y}}px);
                                        transition: {{.animate ? '' : 'none'}};
                                    "
                                ></div>
                            </div><!--/ColorPicker--H-box-->

                        </div><!--/ColorPicker--HSV-wrapper-->

                        <div class="ColorPicker--input">

                            <div class="ColorPicker--input-wrapper-1">
                                <div class="ColorPicker--input-wrapper-2">

                                    <div class="ColorPicker--type-selector-wrapper">

                                        <select class="ColorPicker--type-selector" value="{{.inputType}}">
                                            <option value="{{.TYPE_HEX}}">HEX</option>
                                            <option value="{{.TYPE_RGB}}">RGB</option>
                                        </select>

                                    </div><!--/ColorPicker--type-selector-wrapper-->

                                    <div class="ColorPicker--input-text-wrapper">

                                        {{#if .inputType === .TYPE_HEX}}
                                            <input type="text" value="{{.inputTextHEX}}" class="ColorPicker--input-text ColorPicker--input-text__hex" on-keyup="inputTextHEXChanged()" placeholder="RRGGBB">
                                        {{else}}
                                            <input type="text" value="{{.inputTextR}}" class="ColorPicker--input-text ColorPicker--input-text-rgb" on-keyup="inputTextRGBChanged()" placeholder="R" title="Červená [0–255]">
                                            <input type="text" value="{{.inputTextG}}" class="ColorPicker--input-text ColorPicker--input-text-rgb" on-keyup="inputTextRGBChanged()" placeholder="G" title="Zelená [0–255]">
                                            <input type="text" value="{{.inputTextB}}" class="ColorPicker--input-text ColorPicker--input-text-rgb" on-keyup="inputTextRGBChanged()" placeholder="B" title="Modrá [0–255]">
                                        {{/if}}

                                    </div><!--/ColorPicker--input-text-wrapper-->

                                </div><!--/ColorPicker--input-wrapper-2-->
                            </div><!--/ColorPicker--input-wrapper-1-->

                        </div><!--/ColorPicker--input-->

                    </div><!--/ColorPicker--widget-wrapper-->

                    <div class="ColorPicker--palettes">

                        <ColorPickerPalette title="Vybraná / Původní" colors="[{{current}}, {{initial}}]" addNoColor="{{.noColor}}" type="default" />

                        {{> content}}

                    </div><!--/ColorPicker--palettes-->

                </div><!--/ColorPicker--wrapper-2-->
            </div><!--/ColorPicker--wrapper-1-->

        </div><!--/ColorPicker-->

    </script>

    <script id="ColorPickerPalette" type="text/html">

        {{#if .colors && .colors.length}}

        <div intro="fade" class="ColorPickerPalette">

            <h6 class="ColorPickerPalette--title">{{.title}}</h6>

            <div class="ColorPickerPalette--colors">

            {{#each .colors:i}}
                <div class="ColorPickerPalette--color

                        {{#if ~/type === ~/TYPE_DEFAULT && i === 0 && output === ''}}
                            ColorPickerPalette--color__remove{{#if ~/nearToBlack}}-black{{/if}}
                        {{/if}}
                    "
                    intro="fade"
                    style="
                        background-color: {{this}};
                        transition: {{animate ? '' : 'none'}};
                    "
                    on-click-touchend="setColor:{{this}},{{true}}"
                    title="
                        {{#if ~/type === ~/TYPE_DEFAULT}}
                            {{#if i === 0}}
                               Vybraná: {{formatColor(this, inputType)}}
                            {{else}}
                               Původní: {{formatColor(this, inputType)}}
                            {{/if}}
                        {{else}}
                            {{formatColor(this, inputType)}}
                        {{/if}}
                    "
                ></div><!--/ColorPickerPalette--color-->
            {{/each}}

            {{#if .addNoColor}}
                <div class="ColorPickerPalette--color ColorPickerPalette--color__remove"
                    intro="fade"
                    on-click-touchend="setColor:{{NO_COLOR}}"
                    title="Odstranit / Výchozí"
                ></div>
            {{/if}}
            </div>
        </div><!--/ColorPickerPalette-->

        {{/if}}

    </script>

    <script src="../../../U.js"></script>
    <script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>
    <script src="hammer.min.js"></script>
    <script src="http://cdn.ractivejs.org/edge/ractive.min.js"></script>
    <script src="ractive-touch.js"></script>
    <script src="spectra.js"></script>
    <script src="VibrantForWorker.js"></script>
    <script src="ractive-transitions-fade.umd.js"></script>
    <script>/*jslint indent: 4, white: true, nomen: true, regexp: true, unparam: true, node: true, browser: true, devel: true, nomen: true, plusplus: true, regexp: true, sloppy: true, vars: true*/
    /*global Ractive, Spectra, $, U, Vibrant*/

        window.Promise = window.Promise || Ractive.Promise;

        var ColorPickerPalette = Ractive.extend({
            template: "#ColorPickerPalette",

            noIntro: true,

            data: function () {

                return {
                    TYPE_DEFAULT: "default",

                    formatColor: function (color, format) {

                        if (format === this.parent.get("TYPE_HEX")) {

                            if (this.parent.validateHEX(color)) {

                                return color;
                            }

                            return Spectra(color).hex();

                        } else if (format === this.parent.get("TYPE_RGB")) {

                            if (this.parent.validateRGB(color)) {

                                return color;
                            }

                            var spectra = Spectra(color);

                            return "rgb(" + spectra.red() + ", " + spectra.green() + ", " + spectra.blue() + ")";
                        }

                        return color;
                    }
                }
            },

            computed: {

                nearToBlack: function () {

                    var color = Spectra(this.parent.get("current"));

                    return color.near(Spectra("black"), 50);
                }
            },

            onconfig: function () {

                if (this.get("image")) {

                    setTimeout(function() {

                        this.getPaletteFromImage();

                    }.bind(this), 0);
                }
            },

            onteardown: function () {

                clearTimeout(this.stopVibrantTimeout);
                clearTimeout(this.stopVibrant2Timeout);

                if (this.stopVibrant) {

                    this.stopVibrant();
                }

                if (this.stopVibrant2) {

                    this.stopVibrant2();
                }
            },

            getUniqueRgbs: function (vibrantPalette) {

                var keys = Object.keys(vibrantPalette),
                    c = keys.length - 1,
                    rgbs = [];

                for (c; c >= 0; c--) {

                    if (vibrantPalette[keys[c]]) {

                        vibrantPalette[keys[c]].rgb[0] = Math.round(vibrantPalette[keys[c]].rgb[0]);
                        vibrantPalette[keys[c]].rgb[1] = Math.round(vibrantPalette[keys[c]].rgb[1]);
                        vibrantPalette[keys[c]].rgb[2] = Math.round(vibrantPalette[keys[c]].rgb[2]);

                        var rgbString = "rgb(" + vibrantPalette[keys[c]].rgb.join(",") + ")";

                        if (!~rgbs.indexOf(rgbString)) {

                            rgbs.push(rgbString);
                        }
                    }
                }

                return rgbs;
            },

            findTheLeastSimilarColors: function (rgbs, compareWithRgbs, count) {

                var similarity = {},
                    spectraCache = {},

                    r = rgbs.length - 1,
                    c = compareWithRgbs.length - 1;

                for (r; r >= 0; r--) {

                    var spectra = Spectra(rgbs[r]);

                    similarity[rgbs[r]] = 0;

                    for (c; c >= 0; c--) {

                        var spectra2 = spectraCache[compareWithRgbs[c]] || Spectra(compareWithRgbs[c]);

                        if (!spectraCache[compareWithRgbs[c]]) {

                            spectraCache[compareWithRgbs[c]] = spectra2;
                        }

                        if (spectra.near(spectra2, 10)) {

                            similarity[rgbs[r]] += 3;

                        } else if (spectra.near(spectra2, 20)) {

                            similarity[rgbs[r]] += 2;

                        } else if (spectra.near(spectra2, 30)) {

                            similarity[rgbs[r]] += 1;
                        }
                    }

                    c = compareWithRgbs.length - 1;
                }

                var sorted = Object.keys(similarity).sort(function (a, b) {

                    return similarity[a] - similarity[b];
                });

                return sorted.splice(0, count);
            },

            getPaletteFromImage: function () {

                this.image = new Image();

                this.image.onload = function (e) {

                    var img = e.target,

                        vibrant = new Vibrant(e.target, 32, 7);

                    this.stopVibrant = vibrant.stop;

                    this.stopVibrantTimeout = setTimeout(vibrant.stop, 3000);

                    vibrant.promise.then(function (vibrant) {

                        clearTimeout(this.stopVibrantTimeout);

                        var palette = vibrant.swatches(),

                            rgbs = this.getUniqueRgbs(palette);


                        if (rgbs.length < 5) {

                            var vibrant2 = new Vibrant(img, 5, 10, true);

                            this.stopVibrant2 = vibrant2.stop;

                            this.stopVibrant2Timeout = setTimeout(vibrant2.stop, 3000);

                            vibrant2.promise.then(function (palette) {

                                clearTimeout(this.stopVibrant2Timeout);

                                var rgbs2 = this.getUniqueRgbs(palette),

                                    leastSimilar = this.findTheLeastSimilarColors(rgbs2, rgbs, 5 - rgbs.length);

                                this.merge("colors", this.get("colors").concat(leastSimilar));

                            }.bind(this));
                        }

                        this.set("colors", rgbs);

                    }.bind(this));

                }.bind(this);

                this.image.src = this.get("image");
            }
        });

        var ColorPicker = Ractive.extend({

            template: "#ColorPicker",

            components: {
                ColorPickerPalette: ColorPickerPalette
            },

            computed: {
                SVBoxHue: function () {

                    return this.HBoxColor.hue(this.get("hue") || 0).rgbaString();
                },
                current: function () {

                    return this.currentColor.rgbaString();
                }
            },

            data: function () {

                return {
                    initial: "rgb(255, 255, 255)",

                    SVSelector: {
                        x: 0,
                        y: 0
                    },

                    HSelector: {
                        y: 0
                    },

                    animate: false,

                    inputType: "HEX",
                    inputTextHEX: "",
                    inputTextR: "",
                    inputTextG: "",
                    inputTextB: "",

                    TYPE_HEX: "HEX",
                    TYPE_RGB: "RGB",

                    NO_COLOR: "noColor"
                };
            },

            onconstruct: function () {

                Ractive.$win = Ractive.$win || $(window);

                ColorPicker.instanceCounter = !ColorPicker.instanceCounter ? 1 : ++ColorPicker.instanceCounter;

                this.EVENT_NS = "ColorPicker-" + ColorPicker.instanceCounter;

                Ractive.$win = $(window);
            },

            initializeColors: function () {

                var input = this.get("input");

                input = input || this.get("output");

                if (input) {

                    this.set("initial", input);
                }

                var current = input || this.get("initial");

                this.currentColor = Spectra(current);
                //slouží pro získání barvy gradientu v SVBoxu
                this.HBoxColor = Spectra({ h: 0, s: 1, v: 1 });

                //počáteční hodnoty barvy
                this.skipUdateCurrent = true;
                this.set("hue", this.currentColor.hue());
                this.set("saturation", this.currentColor.saturationv());
                this.skipUdateCurrent = false;
                this.set("value", this.currentColor.value());
            },

            onconfig: function () {

                //nenastavovat barvu při otevření pickeru
                this.waitForUserInteraction = !!this.get("defer");

                this.initializeColors();

                this.observeColorComponents();

                this.observe("current", this.currentColorObserver, {init: false});

                this.observeSelectors();

                this.on("ColorPickerPalette.setColor", function (event, color, animate) {

                    this.setColor(color, animate);

                    event.original.preventDefault();
                });

                this.updateInputFields();

                this.observe("input", function (value) {

//                                        this.waitForUserInteraction = this.get("defer");
//
//                    this.initializeColors();
//
//                    this.moveSelectorsToCurrentColorPosition(true);
//
//                    this.waitForUserInteraction = false;

                }, {init: false});

            },

            currentColorObserver: function (color) {

                if (this.skipUpdateCurrent)  {

                    return;
                }

                //pokud se saturace změní na 0, pak si barva nezachová odstín
                if (!this.preserveCurrentColorHue) {

                    this.skipHueObserver = this.skipUpdateColor;

                    this.set("hue", this.currentColor.hue());

                    this.skipHueObserver = false;
                }

                //pokud si barva nezachovala odstín (černá / bílá) je potřeba ho vrátit, jakmile barva není bílá nebo černá
                if (!this.skipUpdateColor && this.currentColor.hue() !== this.HBoxColor.hue() && (this.currentColor.saturationv() || this.currentColor.value())) {

                    var saturation = this.get("saturation");

                    //Pokud se nastaví černá, saturace se nastaví na 0, když se pak jede po hraně boxu (mění se "value"),
                    //hodnota "saturation" se nezmění (nespustí se observer) a barva tak zůstane šedá.
                    if (saturation && saturation !== this.currentColor.saturationv()) {

                        this.currentColor.saturationv(saturation);
                    }

                    this.currentColor.hue(this.HBoxColor.hue());
                }

                if (!this.waitForUserInteraction) {

                    this.set("output", this.getCurrentRGB());
                    this.fire("output", this.getCurrentRGB());
                }

                this.updateInputFields();
            },

            observeColorComponents: function () {

                this.observe("hue", function (hue) {

                    if (this.skipHueObserver) {

                        return;
                    }

                    this.currentColor.hue(hue);

                    this.update("current");

                }, {init: false});

                this.observe("saturation", function (saturation) {

                    this.currentColor.saturationv(saturation);

                    this.preserveCurrentColorHue = true;

                    this.update("current");

                    this.preserveCurrentColorHue = false;

                }, {init: false});

                this.observe("value", function (value) {

                    this.currentColor.value(value);

                    this.preserveCurrentColorHue = true;

                    this.update("current");

                    this.preserveCurrentColorHue = false;

                }, {init: false});
            },

            observeSelectors: function () {

                this.observe("HSelector.y", function () {

                    if (!this.skipUpdateColor) {

                        this.updateHue.apply(this, arguments);
                    }
                }, {init: false});

                this.observe("SVSelector.x", function () {

                    if (!this.skipUpdateColor) {

                        this.updateSaturation.apply(this, arguments);
                    }
                }, {init: false});

                this.observe("SVSelector.y", function () {

                    if (!this.skipUpdateColor) {

                        this.updateValue.apply(this, arguments);
                    }
                }, {init: false});
            },

            onrender: function () {

                this.SVBox = this.find(".ColorPicker--SV-box");
                this.SVSelector = this.find(".ColorPicker--SV-selector");

                this.HBox = this.find(".ColorPicker--H-box");
                this.HSelector = this.find(".ColorPicker--H-selector");

                this.moveSelectorsToCurrentColorPosition();

                if (!this.waitForUserInteraction) {

                    this.fire("output", this.getCurrentRGB());
                }

                Ractive.$win.on("resize", this.windowResizeHandler.bind(this));

                this.waitForUserInteraction = false;
            },

            onteardown: function () {

                Ractive.$win.off("." + this.EVENT_NS);
            },

            windowResizeHandler: function () {

                clearTimeout(this.windowResizeThrottle);

                this.windowResizeThrottle = setTimeout(function() {

                    this.moveSelectorsToCurrentColorPosition();

                }.bind(this), 100);
            },

            getCurrentRGB: function () {

                return "rgb(" + this.currentColor.red() + ", " + this.currentColor.green() + ", " + this.currentColor.blue() + ")";
            },

            updateInputFields: function () {

                this.set("inputTextHEX", this.currentColor.hex());
                this.set("inputTextR",   this.currentColor.red());
                this.set("inputTextG",   this.currentColor.green());
                this.set("inputTextB",   this.currentColor.blue());
            },

            updateSaturation: function () {

                var width = this.SVBox.offsetWidth,

                    x = this.get("SVSelector.x"),

                    saturation = Math.min(1, Math.max(0, (x / width)));

                this.set("saturation", saturation);
            },

            updateValue: function () {

                var height = this.SVBox.offsetHeight,

                    y = this.get("SVSelector.y"),

                    value = 1 - Math.min(1, Math.max(0, (y / height)));

                this.set("value", value);
            },

            updateHue: function () {

                var height = this.HBox.offsetHeight,

                    y = this.get("HSelector.y"),

                    hue = 360 - Math.min(360, Math.max(0, (y / height) * 360));

                this.preserveCurrentColorHue = true;

                this.set("hue", hue);

                this.preserveCurrentColorHue = false;
            },

            moveSelectorsToCurrentColorPosition: function (animate) {

                this.moveHSelector(this.getHSelectorPosition(), animate);
                this.moveSVSelector(this.getSSelectorPosition(), this.getVSelectorPosition(), animate);
            },

            moveSVSelector: function (x, y, animate) {

                if (this.SVSelector) {

                    var width = this.SVBox.offsetWidth,
                        height = this.SVBox.offsetHeight;

                    x = Math.min(width, Math.max(0, x));
                    y = Math.min(height, Math.max(0, y));

                    this.set("animate", !!animate);

                    this.set("SVSelector.x", x);
                    this.set("SVSelector.y", y);
                }
            },

            moveHSelector: function (y, animate) {

                if (this.HSelector) {

                    var height = this.HBox.offsetHeight;

                    y = Math.min(height, Math.max(0, y));

                    this.set("animate", !!animate);

                    this.set("HSelector.y", y);
                }
            },

            setColor: function (color, animate) {

                if (color === this.get("NO_COLOR")) {

                    this.set("output", "");
                    this.fire("output", "");

                    return;
                }

                this.currentColor = Spectra(color);

                //při zadávání barvy klávesnicí může dojít k malé změně barvy,
                //proto je potřeba zabránit její změně
                this.skipUpdateColor = true;

                //nastavuje se černá nebo bílá barva, sytost by tak zmizela (nastavila se červená - 0)
                this.preserveCurrentColorHue = !this.currentColor.saturationv() && !this.currentColor.saturationv();

                this.update("current");

                this.preserveCurrentColorHue = false;

                this.moveSelectorsToCurrentColorPosition(animate);

                this.skipUpdateColor = false;
            },

            getHSelectorPosition: function () {

                return this.HBox.offsetHeight - ((this.HBox.offsetHeight * (this.HBoxColor.hue() / 360) || this.HBox.offsetHeight));
            },

            getSSelectorPosition: function () {

                return this.SVBox.offsetWidth * this.currentColor.saturationv();
            },

            getVSelectorPosition: function () {

                return this.SVBox.offsetHeight * (1 - this.currentColor.value());
            },

            activateSelector: function(e, type) {

                var eventData = U.eventData(e);

                if (eventData.pointers > 1) {

                    Ractive.$win.off("mousemove." + this.EVENT_NS + " touchmove." + this.EVENT_NS + " mouseup." + this.EVENT_NS + " touchend." + this.EVENT_NS)

                    clearTimeout(this[type === "SV" ? "moveSVToPositionTimeout"   : "moveHToPositionTimeout"]);

                    return;
                }

                var movedToPosition = false,

                    selector              = type === "SV" ? ".ColorPicker--SV-selector" : ".ColorPicker--H-selector",
                    box                   = type === "SV" ? ".ColorPicker--SV-box"      : ".ColorPicker--H-box",
                    moveToPositionTimeout = type === "SV" ? "moveSVToPositionTimeout"   : "moveHToPositionTimeout",
                    moveSelectorFn        = type === "SV" ? "moveSVSelector"            : "moveHSelector",
                    dataSelector          = type === "SV" ? "SVSelector"                : "HSelector",

                    $selector = $(eventData.target).closest(selector),

                    selectorPosition = $selector.position(),
                    selectorHeight = $selector.height(),
                    selectorWidth = $selector.width(),

                    initPositions = {};

                initPositions.pointerY = eventData.clientY;
                initPositions.pointerX = eventData.clientX;

                initPositions.handleY = this.get(dataSelector + ".y");

                if (type === "SV") {

                    initPositions.handleX = this.get(dataSelector + ".x");
                }

                initPositions.startOffsetX = eventData.offsetX;
                initPositions.startOffsetY = eventData.offsetY;

                //událost vznikla na selektoru - je potřeba upravit pozici
                if ($selector.length) {

                    initPositions.startOffsetX += selectorPosition.left;
                    initPositions.startOffsetY += selectorPosition.top;
                }

                var moveToStartEventPosition = function (animate, byEndEvent) {

                    var args = [initPositions.startOffsetY, animate];

                        if (type === "SV") {

                            args.unshift(initPositions.startOffsetX);
                        }

                        this[moveSelectorFn].apply(this, args);

                        if (!byEndEvent) {

                            if (type === "SV") {

                                initPositions.handleY = this.getVSelectorPosition();
                                initPositions.handleX = this.getSSelectorPosition();

                            } else {

                                initPositions.handleY = this.getHSelectorPosition();
                            }
                        }

                        movedToPosition = true;

                    }.bind(this);

                clearTimeout(this[moveToPositionTimeout]);

                //pokud uživatel nepohne myší/prstem => přesunout na místo
                this[moveToPositionTimeout] = setTimeout(moveToStartEventPosition.bind(this, true), eventData.isTouchEvent ? 200 : 100);

                Ractive.$win
                    .off("mousemove." + this.EVENT_NS + " touchmove." + this.EVENT_NS + " mouseup." + this.EVENT_NS + " touchend." + this.EVENT_NS)
                    .on("mousemove." + this.EVENT_NS + " touchmove." + this.EVENT_NS, function (e) {

                        var eventData = U.eventData(e);

                        if (eventData.pointers > 1) {

                            clearTimeout(this[moveToPositionTimeout]);

                            Ractive.$win.off("mousemove." + this.EVENT_NS + " touchmove." + this.EVENT_NS + " mouseup." + this.EVENT_NS + " touchend." + this.EVENT_NS)

                            return;
                        }

                        if (!movedToPosition) {

                            clearTimeout(this[moveToPositionTimeout]);

                            //nejdříve je potřeba přesunout selektor na pozici myši/prstu
                            moveToStartEventPosition();
                        }

                        var args = [
                            initPositions.handleY + eventData.clientY - initPositions.pointerY
                        ];

                        if (type === "SV") {

                            args.unshift(initPositions.handleX + eventData.clientX - initPositions.pointerX);
                        }

                        this[moveSelectorFn].apply(this, args);

                        e.preventDefault();
                        return false;

                    }.bind(this))
                    .one("mouseup." + this.EVENT_NS + " touchend." + this.EVENT_NS, function (e) {

                        if (!movedToPosition) {

                            clearTimeout(this[moveToPositionTimeout]);

                            moveToStartEventPosition(true, true);
                        }

                        Ractive.$win.off("mousemove." + this.EVENT_NS + " touchmove." + this.EVENT_NS);

                        e.preventDefault();
                        return false;

                    }.bind(this));

                eventData.preventDefault();
                return false;
            },

            validateRGB: function (color) {

                return /^\s*rgb\(\s*(?:\d{1,3})\s*,\s*(?:\d{1,3})\s*,\s*(?:\d{1,3})\s*\)\s*$/.test(color);
            },

            validateHEX: function (color) {

                return /^\s*#?[0-9a-f]{6}\s*$/i.test(color);
            },

            inputTextHEXChanged: function () {

                var currentHEX = this.get("inputTextHEX");

                if (this.validateHEX(currentHEX)) {

                    this.setColor(~currentHEX.indexOf("#") ? currentHEX : "#" + currentHEX, true);

                } else {

                    var hash = currentHEX.indexOf("#"),
                        ch = currentHEX.length;

                    //zkrátit příliš dlouhou hodnotu
                    if (ch > 6 && !~hash || ch > 7 && ~hash) {

                        currentHEX = currentHEX.substr(0, 7 + currentHEX.indexOf("#"));

                        ch = currentHEX.length - 1;
                    }

                    //písmena "větší" než f změnit na f
                    for (--ch; ch >= 0; ch--) {

                        if (currentHEX[ch] !== "#" && isNaN(parseInt(currentHEX[ch], 16))) {

                            currentHEX = currentHEX.substr(0, ch) + "f" + currentHEX.substr(ch + 1);
                        }
                    }

                    this.set("inputTextHEX", currentHEX);

                    if (this.validateHEX(currentHEX)) {

                        this.setColor(~hash ? currentHEX : "#" + currentHEX, true);
                    }
                }
            },

            inputTextRGBChanged: function () {

                var red = this.get("inputTextR"),
                    green = this.get("inputTextG"),
                    blue = this.get("inputTextB"),

                    currentRGB = "rgb(" + red + ", " + green + ", " + blue + ")";

                if (this.validateRGB(currentRGB)) {

                    this.setColor(currentRGB, true);

                } else {

                    red = Math.min(255, Math.max(0, red));
                    green = Math.min(255, Math.max(0, green));
                    blue = Math.min(255, Math.max(0, blue));

                    this.set("inputTextR", red || 0);
                    this.set("inputTextG", green || 0);
                    this.set("inputTextB", blue || 0);

                    this.inputTextRGBChanged();
                }
            }

        });

        var app = new Ractive({
            el: "#app",
            template: "#App",

            components: {
                ColorPicker: ColorPicker
            },

            partials: {

            },
            data: {
//                color: "rgb(255, 255, 0)",
//                border: "rgb(0, 0, 250)"
            },

            onconfig: function () {

                this.on("changeColor", this.changeColor);

            },

            changeColor: function (type, color) {
                console.log(arguments);
                this.set(type, color);
            }
        });

        var picker = app.findComponent("ColorPicker");
        var picker2 = app.findAllComponents("ColorPicker")[1];

    </script>



</body>
</html>
