<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height">

    <link rel="stylesheet" href="../editor.css">

    <style>

        html, body {
            will-change: scroll-position;
            position: relative;
            min-height: 100%;
        }

        body {
            padding: 20px;
        }

        * {
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            margin: 0;
        }

        body > .edit {
            padding-bottom: 80px;
        }

    </style>

</head>

<body>


    <div class="edit">Lorem ipsum dolor sit amet.</div>
    <div class="edit">Lorem ipsum dolor sit amet. ipsum dolor sit amet.</div>
    <div class="edit">Lorem ipsum dolor sit amet.</div>
    <div class="edit">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Nesciunt dignissimos id veniam at culpa minima modi neque consequatur expedita, delectus? ipsum dolor sit amet.</div>
    <div class="edit">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Deserunt incidunt autem corporis et consectetur qui delectus cupiditate fugit tenetur iusto tempore voluptas sapiente distinctio quas vitae dolorum, sit, eum voluptatem quasi unde minima id quos. Fugiat quaerat nihil unde amet vitae, atque ipsa reiciendis mollitia voluptatum dolorum, facere assumenda eaque porro. Omnis quia officia odio quis fugit nemo qui illo accusamus ipsam, sint ab asperiores doloremque eaque architecto, voluptatibus voluptate temporibus fuga, ratione quasi necessitatibus libero quos ea suscipit. Ex nemo numquam nam quos, culpa qui recusandae quaerat quo? Eos perspiciatis harum aspernatur nam doloremque accusamus beatae, odit labore tempore pariatur earum, sapiente soluta quia vitae odio fuga qui! Ad voluptatibus eius sunt voluptas, deleniti laborum dolores facere quia! Maiores vitae perferendis iste, temporibus pariatur. Dignissimos nihil odio eos minima tenetur, explicabo iure eum possimus hic vitae cumque consequatur quas porro iste sunt distinctio sequi modi culpa ullam libero ab qui laboriosam. Nihil reiciendis ullam commodi, amet in qui numquam dolor voluptatibus officia at aliquam error nisi non nobis saepe quidem, et magnam dolorum nam? Quisquam ut pariatur accusamus qui, officia cum, soluta quaerat dolore aliquam quae vel rerum itaque suscipit consectetur distinctio nesciunt ad possimus. Dolore ex eveniet facilis unde assumenda iste reiciendis consequuntur illo iusto natus neque dolor, laboriosam accusantium, dolorum adipisci modi labore tempore explicabo voluptas numquam molestiae doloribus distinctio ipsum. Accusamus expedita officiis aliquid, explicabo suscipit iure ad mollitia doloremque ullam repudiandae, inventore fugit voluptatum. Ex explicabo illum officiis perferendis magnam rem officia sed culpa esse harum blanditiis, ipsam ipsum quaerat cupiditate sit modi enim non voluptas maiores sequi laboriosam, quia animi ad. Porro accusamus, sequi rerum tenetur possimus natus libero. Aliquid nisi placeat maxime explicabo animi laudantium accusantium aspernatur dicta dolore delectus esse necessitatibus consectetur doloremque commodi dolorum vero suscipit velit, veniam nulla! Distinctio, maxime. ipsum dolor sit amet.</div>

    <script src="jquery-1.12.1.min.js"></script>
    <script src="http://mjerabek.wz.cz/onScreenLog.js"></script>

    <script src="editor.js"></script>

    <script>
    /*jslint indent: 4, white: true, nomen: true, regexp: true, unparam: true, node: true, browser: true, devel: true, nomen: true, plusplus: true, regexp: true, sloppy: true, vars: true*/clearInterval
    /*global $, jQuery*/

        var FixedElement = (function ($) {

            var $win = $(window),

                constructor = function FixedElement($selectable, throttle) {

                    this.id = "fixedElement" + (+new Date());

                    this.$fixedElement = $($selectable);

                    this.throttle = throttle || 100;

                    this.init();
                };

            constructor.prototype.fix = function(eOrNoTransitions, noTransitions) {

                if (eOrNoTransitions === true || noTransitions) {

                    this.$fixedElement.css({
                        transition: "none"
                    });
                }

                var position = this.calculatePosition();

                this.transform(position.left, position.top);

                if (eOrNoTransitions === true || noTransitions) {

                    setTimeout(function() {

                        this.$fixedElement.css({
                            transition: ""
                        });

                    }.bind(this), 0);
                }
            };

            constructor.prototype.fixOnNext = function(noTransitions) {

                setTimeout(this.fix.bind(this, noTransitions), 0);
            };

            constructor.prototype.init = function () {

                this.$fixedElement.css({
                    transition: "none"
                });

                var throttle = null;

                $win.on("scroll." + this.id + " resize." + this.id, function () {

                    clearTimeout(throttle);

                    throttle = setTimeout(this.fix.bind(this), this.throttle);

                }.bind(this));

                this.fix();

                setTimeout(function() {

                    this.$fixedElement.css({
                        transition: ""
                    });

                }.bind(this), 0);
            };

            constructor.prototype.destroy = function () {

                $win.off("scroll." + this.id + " resize." + this.id);
            };

            constructor.prototype.calculatePosition = function () {

                var scrollWidth = document.documentElement.scrollWidth,
                    scrollHeight = document.documentElement.scrollHeight,
                    viewWidth = document.documentElement.clientWidth > window.innerWidth ? window.innerWidth : document.documentElement.clientWidth,
                    viewHeight = document.documentElement.clientHeight > window.innerHeight ? window.innerHeight : document.documentElement.clientHeight,

                    scrollLeft = Math.max(0, $win.scrollLeft()),
                    scrollTop = Math.max(0, $win.scrollTop());

                scrollLeft = Math.min(scrollLeft, scrollWidth - viewWidth);
                scrollTop = Math.min(scrollTop, (scrollHeight - viewHeight));

                if (this.isFixedToRight()) {

                    scrollLeft = scrollLeft - (scrollWidth - viewWidth);
                }

                if (this.isFixedToBottom()) {

                    scrollTop = scrollTop - (scrollHeight - viewHeight);
                }

                return {
                    top: scrollTop,
                    left: scrollLeft
                };
            };

            constructor.prototype.transform = function (left, top) {

                this.$fixedElement.css({
                    transform: "translate(" + left + "px, " + top + "px)"
                });
            };

            constructor.prototype.isFixedToRight = function () {

                var css = this.$fixedElement.css("right");

                return !isNaN(parseFloat(css)) || css.match(/calc/);
            };

            constructor.prototype.isFixedToLeft = function () {

                var css = this.$fixedElement.css("left");

                return !isNaN(parseFloat(css)) || css.match(/calc/);
            };

            constructor.prototype.isFixedToTop = function () {

                var css = this.$fixedElement.css("top");

                return !isNaN(parseFloat(css)) || css.match(/calc/);
            };

            constructor.prototype.isFixedToBottom = function () {

                var css = this.$fixedElement.css("bottom");

                return !isNaN(parseFloat(css)) || css.match(/calc/);
            };


            return constructor;

        }(jQuery));

    </script>

    <script>
        /*jslint indent: 4, white: true, nomen: true, regexp: true, unparam: true, node: true, browser: true, devel: true, nomen: true, plusplus: true, regexp: true, sloppy: true, vars: true*/
        /*global MediumEditor, $*/

        MediumEditor.extensions.anchor.prototype._showForm = MediumEditor.extensions.anchor.prototype.showForm;

        MediumEditor.extensions.anchor.prototype.showForm = function () {

            MediumEditor.extensions.anchor.prototype._showForm.apply(this, arguments);

            this.getForm().classList.add("medium-editor-action-createLink-displayed");
        };

        MediumEditor.extensions.anchor.prototype._hideForm = MediumEditor.extensions.anchor.prototype.hideForm;

        MediumEditor.extensions.anchor.prototype.hideForm = function () {

            MediumEditor.extensions.anchor.prototype._hideForm.apply(this, arguments);

            this.getForm().classList.remove("medium-editor-action-createLink-displayed");
        };

        MediumEditor.extensions.anchor.prototype.isDisplayed = function () {

            return this.getForm().classList.contains("medium-editor-action-createLink-displayed");
        };

        MediumEditor.extensions.toolbar.prototype._init = MediumEditor.extensions.toolbar.prototype.init;

        MediumEditor.extensions.toolbar.prototype.init = function () {

            this.$win = $(window);

            this.base.toolbar = this;

            this._init.apply(this, arguments);

            this.getToolbarActionsElement().classList.add("medium-editor-default-actions-displayed");
            this.toolbar.classList.add("medium-editor-default-actions-displayed");

            this.toolbar.classList.add("medium-editor-force-left");
            this.toolbar.classList.add("medium-editor-force-top");

            this.beforeFill = document.createElement("div");
            this.beforeFill.classList.add("medium-editor-before-fill");

            this.afterFill = document.createElement("div");
            this.afterFill.classList.add("medium-editor-after-fill");

            this.toolbar.appendChild(this.afterFill);
            this.toolbar.insertBefore(this.beforeFill, this.toolbar.children[0]);
        };

        MediumEditor.extensions.toolbar.prototype._showToolbar = MediumEditor.extensions.toolbar.prototype.showToolbar;

        MediumEditor.extensions.toolbar.prototype.showToolbar = function () {

            if (!this.isDisplayed()) {

                this.$win.off("mousedown.medium-editor-first-show-" + this.base.id);
                this.$win.off("touchstart.medium-editor-first-show-" + this.base.id);

                this.$win.one("mousedown.medium-editor-first-show-" + this.base.id + " " + "touchstart.medium-editor-first-show-" + this.base.id, function () {

                    this.toolbar.classList.remove("medium-editor-first-show");

                }.bind(this));

                this.toolbar.classList.add("medium-editor-first-show");

            }
            MediumEditor.extensions.toolbar.prototype._showToolbar.apply(this, arguments);


        };

        MediumEditor.extensions.toolbar.prototype._hideToolbar = MediumEditor.extensions.toolbar.prototype.hideToolbar;

        MediumEditor.extensions.toolbar.prototype.hideToolbar = function () {

            if (this.isDisplayed()) {

                this.$win.off("mousedown.medium-editor-first-show-" + this.base.id);
                this.$win.off("touchstart.medium-editor-first-show-" + this.base.id);

                this.toolbar.classList.remove("medium-editor-first-show");

                this.hideExtensionForms();
                this.showToolbarDefaultActions(true);
            }

            MediumEditor.extensions.toolbar.prototype._hideToolbar.apply(this, arguments);
        };

        MediumEditor.extensions.toolbar.prototype.isToolbarDefaultActionsDisplayed = function () {

            return this.getToolbarActionsElement().classList.contains("medium-editor-default-actions-displayed");
        };

        MediumEditor.extensions.toolbar.prototype.hideToolbarDefaultActions = function () {

            if (this.isToolbarDefaultActionsDisplayed()) {

                this.getToolbarActionsElement().classList.add("medium-editor-default-actions-hidden");
                this.getToolbarActionsElement().classList.remove("medium-editor-default-actions-displayed");
                this.toolbar.classList.add("medium-editor-default-actions-hidden");
                this.toolbar.classList.remove("medium-editor-default-actions-displayed");
            }
        };

        MediumEditor.extensions.toolbar.prototype.showToolbarDefaultActions = function (dontShowToolbar) {

            this.hideExtensionForms();

            if (!this.isToolbarDefaultActionsDisplayed()) {

                this.getToolbarActionsElement().classList.remove("medium-editor-default-actions-hidden");
                this.getToolbarActionsElement().classList.add("medium-editor-default-actions-displayed");
                this.toolbar.classList.remove("medium-editor-default-actions-hidden");
                this.toolbar.classList.add("medium-editor-default-actions-displayed");
            }

            if (dontShowToolbar) {

                return;
            }

            // Using setTimeout + options.delay because:
            // We will actually be displaying the toolbar, which should be controlled by options.delay
            this.delayShowTimeout = this.base.delay(function () {
                this.showToolbar();
            }.bind(this));
        };

        MediumEditor.extensions.toolbar.prototype.hideExtensionForms = function () {

            // Hide all extension forms
            this.forEachExtension(function (extension) {

                if (extension.action === "createLink") {

                    if (extension.isDisplayed()) {

                        extension.getForm().classList.remove("medium-editor-action-createLink-displayed");

                        extension.getInput().value = "";
                    }

                    return;
                }
                if (extension.hasForm && extension.isDisplayed()) {
                    extension.hideForm();
                }
            });
        };

        MediumEditor.extensions.toolbar.prototype.setFillGrow = function (before, after) {
            this.beforeFill.style.webkitFlexGrow = before;
            this.beforeFill.style.mozFlexGrow = before;
            this.beforeFill.style.msFlexGrow = before;
            this.beforeFill.style.oFlexGrow = before;
            this.beforeFill.style.flexGrow = before;
            this.afterFill.style.webkitFlexGrow = after;
            this.afterFill.style.mozFlexGrow = after;
            this.afterFill.style.msFlexGrow = after;
            this.afterFill.style.oFlexGrow = after;
            this.afterFill.style.flexGrow = after;
        };

        MediumEditor.extensions.toolbar.prototype.positionTouchToolbar = function (selection) {

            var toolbarElement = this.getToolbarElement();

            toolbarElement.style.top = '';
            toolbarElement.style.left = '';

            if (this.base.events.touchSupport.used) {

                toolbarElement.classList.remove("medium-editor-force-left");
                toolbarElement.classList.remove("medium-editor-force-right");
                toolbarElement.classList.remove("medium-editor-force-bottom");
                toolbarElement.classList.remove("medium-editor-force-top");

                if (this.base.events.touchSupport.forceDirectionX !== "right") {

                    toolbarElement.classList.add("medium-editor-force-left");

                } else {

                    toolbarElement.classList.add("medium-editor-force-right");
                }

                if (this.base.events.touchSupport.forceDirectionY !== "bottom") {

                    toolbarElement.classList.add("medium-editor-force-top");

                } else {

                    toolbarElement.classList.add("medium-editor-force-bottom");
                }

                this.fixedElement = this.fixedElement || new FixedElement(this.toolbar);

                if ((this.base.events.touchSupport.forceDirectionY !== this.base.events.touchSupport.lastForceDirectionY) ||
                    (this.base.events.touchSupport.forceDirectionX !== this.base.events.touchSupport.lastForceDirectionX)) {

                        this.fixedElement.fix(true);
                }

                this.base.events.touchSupport.lastForceDirectionX = this.base.events.touchSupport.forceDirectionX;
                this.base.events.touchSupport.lastForceDirectionY = this.base.events.touchSupport.forceDirectionY;
            }
        };

        MediumEditor.extensions.toolbar.prototype.positionToolbar = function (selection) {

            var toolbarElement = this.getToolbarElement();

            if (toolbarElement.classList.contains("medium-editor-use-touch")) {

                this.positionTouchToolbar.apply(this, arguments);

                return;
            }

            toolbarElement.classList.remove('medium-editor-left-edge');
            toolbarElement.classList.remove('medium-editor-right-edge');

            var range = selection.getRangeAt(0),
                boundary = range.getBoundingClientRect();

            // Handle selections with just images
            if (!boundary || ((boundary.height === 0 && boundary.width === 0) && range.startContainer === range.endContainer)) {
                // If there's a nested image, use that for the bounding rectangle
                if (range.startContainer.nodeType === 1 && range.startContainer.querySelector('img')) {
                    boundary = range.startContainer.querySelector('img').getBoundingClientRect();
                } else {
                    boundary = range.startContainer.getBoundingClientRect();
                }
            }

            var windowWidth = this.window.innerWidth,
                middleBoundary = (boundary.left + boundary.right) / 2,
                toolbarHeight = toolbarElement.offsetHeight,
                toolbarWidth = toolbarElement.offsetWidth,

                toolbarActionsElement = this.getToolbarActionsElement(),

                fillWidth = (toolbarWidth - toolbarActionsElement.offsetWidth) / 2,

                halfOffsetWidth = toolbarWidth / 2,
                buttonHeight = toolbarHeight,
                defaultLeft = this.diffLeft - halfOffsetWidth;

            if (this.isToolbarDefaultActionsDisplayed() && this.savedFillWidth) {

                fillWidth = this.savedFillWidth;

                this.savedFillWidth = null;

            } else if (!this.isToolbarDefaultActionsDisplayed()) {

                fillWidth = this.savedFillWidth || fillWidth;

                this.savedFillWidth = fillWidth;
            }

            if (boundary.top < toolbarHeight) {

                toolbarElement.classList.add('medium-toolbar-arrow-over');
                toolbarElement.classList.remove('medium-toolbar-arrow-under');
                toolbarElement.style.top = toolbarHeight + boundary.bottom - this.diffTop + this.window.pageYOffset - toolbarHeight + 'px';

            } else {

                toolbarElement.classList.add('medium-toolbar-arrow-under');
                toolbarElement.classList.remove('medium-toolbar-arrow-over');
                toolbarElement.style.top = boundary.top + this.diffTop + this.window.pageYOffset - toolbarHeight + 'px';
            }

            var fillGrow = 1;

            if (middleBoundary < halfOffsetWidth) {

                toolbarElement.classList.add('medium-editor-left-edge');
                toolbarElement.style.left = defaultLeft + halfOffsetWidth + 'px';

                fillGrow = 1 - Math.max(0, Math.min(fillWidth, halfOffsetWidth - middleBoundary)) / fillWidth;

                this.setFillGrow(fillGrow, 2 - fillGrow);

            } else if ((windowWidth - middleBoundary) < halfOffsetWidth) {

                toolbarElement.classList.add('medium-editor-right-edge');
                toolbarElement.style.left = windowWidth - toolbarWidth + "px";

                fillGrow = 1 - Math.min(fillWidth, Math.max(0, ((halfOffsetWidth + middleBoundary) - windowWidth))) / fillWidth;

                this.setFillGrow(2 - fillGrow, fillGrow);

            } else {

                toolbarElement.style.left = defaultLeft + middleBoundary + 'px';

                this.setFillGrow(1, 1);
            }
        }

        MediumEditor.Events.prototype._handleBodyMousedown = MediumEditor.Events.prototype.handleBodyMousedown;

        MediumEditor.Events.prototype.handleBodyMousedown = function () {

            if (this.touchSupport.bodyTouchstart) {

                this.touchSupport.bodyTouchstart = false;

                return;
            }

            this._handleBodyMousedown.apply(this, arguments);
        };

        MediumEditor.Events.prototype._handleBodyClick = MediumEditor.Events.prototype.handleBodyClick;

        MediumEditor.Events.prototype.handleBodyClick = function () {

            if (this.touchSupport.bodyTouchend) {

                this.touchSupport.bodyTouchend = false;

                return;
            }

            this._handleBodyClick.apply(this, arguments);
        };

        MediumEditor.Events.prototype._setupListener = MediumEditor.Events.prototype.setupListener;

        MediumEditor.Events.prototype.setupListener = function (name) {

            this.touchSupport = this.touchSupport || {
                touches: 0
            };

            if (name === "externalInteraction" && !this.touchSupport.attachedExternalInteraction) {

                this.attachDOMEvent(this.options.ownerDocument.body, 'touchstart', function (e) {

                    if (!this.base.toolbar.toolbar.classList.contains("medium-editor-use-touch")) {

                        this.base.toolbar.toolbar.classList.add("medium-editor-use-touch");
                    }

                    this.touchSupport.used = true;
                    this.touchSupport.touches = e.touches.length > this.touchSupport.touches ? e.touches.length : this.touchSupport.touches;
                    this.touchSupport.zoom = document.documentElement.clientWidth / window.innerWidth;

                    if (e.touches.length === 3) {

                        this.touchSupport.startX = e.touches[2].clientX;
                        this.touchSupport.startY = e.touches[2].clientY;
                    }

                    if (e.touches.length === 1) {

                        this.touchSupport.bodyTouchstart = false;

                        this.handleBodyMousedown.apply(this, arguments);

                        this.touchSupport.bodyTouchstart = true;
                    }

                }.bind(this), true);

                this.attachDOMEvent(this.options.ownerDocument.body, 'touchmove', function (e) {

                    this.touchSupport.bodyTouchmove = true;

                    var directionChanged = false;

                    if (!this.touchSupport.toolbarSwitched && e.touches[2] && this.base.getFocusedElement()) {

                        if (this.base.toolbar.toolbar.classList.contains("medium-editor-toolbar-active")) {

                            e.preventDefault();

                            if (Math.abs(this.touchSupport.startY - e.touches[2].clientY) > 40 / this.touchSupport.zoom) {

                                if (this.touchSupport.startY - e.touches[2].clientY > 0) {

                                    this.base.events.touchSupport.forceDirectionY = "top";

                                } else {

                                    this.base.events.touchSupport.forceDirectionY = "bottom";
                                }

                                directionChanged = true;
                            }
                        }
                    }

                    if (!this.touchSupport.toolbarSwitched && e.touches[2] && this.base.getFocusedElement()) {

                        if (this.base.toolbar.toolbar.classList.contains("medium-editor-toolbar-active")) {

                            e.preventDefault();

                            if (Math.abs(this.touchSupport.startX - e.touches[2].clientX) > 40 / this.touchSupport.zoom) {

                                if (this.touchSupport.startX - e.touches[2].clientX > 0) {

                                    this.base.events.touchSupport.forceDirectionX = "left";

                                } else {

                                    this.base.events.touchSupport.forceDirectionX = "right";
                                }

                                directionChanged = true;
                            }
                        }
                    }

                    if (directionChanged) {

                        this.touchSupport.toolbarSwitched = true;

                        this.base.toolbar.setToolbarPosition();
                    }

                }.bind(this), true);

                this.attachDOMEvent(this.options.ownerDocument.body, 'touchend', function (e) {

                    clearTimeout(this.touchSupport.touchesTimeout);

                    this.touchSupport.touchesTimeout = setTimeout(function () {

                        this.touchSupport.touches = 0;
                        this.touchSupport.toolbarSwitched = false;

                    }.bind(this), 75);

                    if (this.touchSupport.touches > 1) {

                        return;
                    }

                    if (e.touches.length === 0) {

                        this.touchSupport.bodyTouchend = false;

                        var $target = $(e.target),
                            $closestEditor = $target.closest("[data-medium-editor-element]"),
                            $closestToolbar = $target.closest(".medium-editor-toolbar"),
                            focusedEditor = this.base.getFocusedElement();

                        this.touchSupport.onToolbarTouchend = $closestToolbar.length;

                        if (!this.touchSupport.bodyTouchmove && (!focusedEditor || focusedEditor !== $closestEditor[0])) {

                            $closestEditor.focus();
                        }

                        if (!this.touchSupport.bodyTouchmove && focusedEditor &&
                            !$closestToolbar.length && !$closestEditor.length) {

                            this.base.events.touchSupport.forceDirectionY = "top";

                            $(focusedEditor).blur();
                        }

                        if (!this.touchSupport.bodyTouchmove) {

                            this.handleBodyClick.apply(this, arguments);
                        }

                        this.touchSupport.toolbarSwitched = false;
                        this.touchSupport.bodyTouchmove = false;
                        this.touchSupport.bodyTouchend = true;
                    }

                }.bind(this), true);

                this.touchSupport.attachedExternalInteraction = true;

            } else if (name === "editableClick" && !this.touchSupport.attachedEditableClick) {

                this.attachDOMEvent(this.options.ownerDocument, 'selectionchange', function () {

                    if (!this.touchSupport.used || !this.base.getFocusedElement()) {

                        return;
                    }

                    var args = arguments;

                    clearTimeout(this.touchSupport.selectionTimeout);

                    this.touchSupport.selectionTimeout = setTimeout(function () {

                        if (this.touchSupport.onToolbarTouchend) {

                            return;
                        }

                        this.handleClick.apply(this, args);

                    }.bind(this), 300);

                }.bind(this));

                this.touchSupport.attachedEditableClick = true;
            }

            this._setupListener.apply(this, arguments);
        };
    </script>
    <script>
        var editor = new MediumEditor(".edit", {
            toolbar: {
//                                buttons: ["bold", "italic", "anchor", "h2", "unorderedlist", "orderedlist"]
                buttons: ["bold", "italic", "anchor"]
            }
        });

    </script>


</body>

</html>
